# ÂÜÖÈÉ®ÁΩëÁªúÁâàÊú¨ - ‰∏çÊö¥Èú≤Êï∞ÊçÆÂ∫ìÁ´ØÂè£Âà∞‰∏ªÊú∫ÔºàÊõ¥ÂÆâÂÖ®Ôºâ
#
# üöÄ ÂêØÂä®ËØ¥ÊòéÔºö
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# 1. ÂêØÂä®ÊâÄÊúâÊ†∏ÂøÉÊúçÂä°ÔºàPostgreSQL + Redis + Django + Nginx + RustFSÔºâ:
#    docker-compose up -d
#
# 2. ÂêØÂä®ÂÖ®ÈÉ®ÊúçÂä°ÔºàÂåÖÂê´ Flower ÁõëÊéßÔºâ:
#    docker-compose --profile Flower up -d
#
# 3. Êü•ÁúãÊâÄÊúâÊúçÂä°Áä∂ÊÄÅ:
#    docker-compose ps -a
#
# 4. ÂÅúÊ≠¢Âπ∂Âà†Èô§ÊâÄÊúâÊúçÂä°:
#    docker-compose down
#
# üì¶ RustFS ÂØπË±°Â≠òÂÇ®ÔºàÂøÖÈúÄÊúçÂä° - ÈªòËÆ§ÂêØÂä®Ôºâ:
#    - ÁÆ°ÁêÜÊéßÂà∂Âè∞: http://ÊúçÂä°Âô®IP:7901ÔºàÁõ¥Êé•ËÆøÈóÆÔºå‰∏çÈÄöËøá Nginx ‰ª£ÁêÜÔºâ
#    - Êñá‰ª∂ËÆøÈóÆ: http://ÊúçÂä°Âô®IP/media/ÔºàÈÄöËøá Nginx ‰ª£ÁêÜÔºå‰∏çÊö¥Èú≤Ê°∂ÂêçÁß∞Ôºâ
#    - API Á´ØÂè£Ôºà9000Ôºâ: ‰ªÖÂÜÖÈÉ®ÁΩëÁªúËÆøÈóÆÔºå‰∏çÂØπÂ§ñÊö¥Èú≤ÔºåÁ°Æ‰øùÂÆâÂÖ®ÊÄß
#    - ÈªòËÆ§Ë¥¶Âè∑ÂØÜÁ†Å: rustfsadmin / Êü•Áúã .env Êñá‰ª∂‰∏≠ÁöÑ RUSTFS_ROOT_PASSWORD
#    - Ê≥®ÊÑè: ÂØπË±°Â≠òÂÇ®Â∑≤ÈªòËÆ§ÂêØÁî®
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

services:
  # PostgreSQL Êï∞ÊçÆÂ∫ì
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:17-bookworm}
    container_name: ${CONTAINER_PREFIX:-secsnow}-postgres
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-secsnow}
      POSTGRES_USER: ${POSTGRES_USER:-secsnow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secsnow123456}
      POSTGRES_INITDB_ARGS: --auth-host=md5
      PGDATA: /var/lib/postgresql/data/pgdata
      TZ: Asia/Shanghai
    volumes:
      - ${POSTGRES_DATA_DIR:-./db/postgres}:/var/lib/postgresql/data
    # ‰∏çÊö¥Èú≤Á´ØÂè£Âà∞‰∏ªÊú∫ÔºåÂè™Âú®ÂÜÖÈÉ®ÁΩëÁªúËÆøÈóÆ
    networks:
      - secsnow-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-secsnow}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PgBouncer ËøûÊé•Ê±†
  pgbouncer:
    image: ${PGBOUNCER_IMAGE:-edoburu/pgbouncer:latest}
    container_name: ${CONTAINER_PREFIX:-secsnow}-pgbouncer
    restart: always
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-secsnow}:${POSTGRES_PASSWORD:-secsnow123456}@postgres:5432/${POSTGRES_DB:-secsnow}
      AUTH_TYPE: scram-sha-256
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 1000
      DEFAULT_POOL_SIZE: 25
      MIN_POOL_SIZE: 5
      RESERVE_POOL_SIZE: 5
      SERVER_IDLE_TIMEOUT: 60
      SERVER_LIFETIME: 3600
      MAX_DB_CONNECTIONS: 50
      TZ: Asia/Shanghai
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - secsnow-network
    healthcheck:
      test: ["CMD-SHELL", "PGPASSWORD=${POSTGRES_PASSWORD:-secsnow123456} psql -h 127.0.0.1 -p 5432 -U ${POSTGRES_USER:-secsnow} -d ${POSTGRES_DB:-secsnow} -c 'SELECT 1;' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Redis ÁºìÂ≠òÂíåÊ∂àÊÅØÈòüÂàó
  redis:
    image: ${REDIS_IMAGE:-redis:8.4.0}
    container_name: ${CONTAINER_PREFIX:-secsnow}-redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis123456} --appendonly yes
    environment:
      TZ: Asia/Shanghai
    volumes:
      - ${REDIS_DATA_DIR:-./redis/data}:/data
    # ‰∏çÊö¥Èú≤Á´ØÂè£Âà∞‰∏ªÊú∫ÔºåÂè™Âú®ÂÜÖÈÉ®ÁΩëÁªúËÆøÈóÆ
    networks:
      - secsnow-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RustFS ÂØπË±°Â≠òÂÇ®ÔºàÂøÖÈúÄÊúçÂä° - ÈªòËÆ§ÂêØÂä®Ôºâ
  rustfs:
    image: ${RUSTFS_IMAGE:-rustfs/rustfs:latest}
    container_name: ${CONTAINER_PREFIX:-secsnow}-rustfs
    restart: always
    user: "0:0"  # ‰ª• root Áî®Êà∑ËøêË°åÔºåÈÅøÂÖçÊùÉÈôêÈóÆÈ¢ò
    security_opt:
      - "no-new-privileges:true"
    environment:
      # Êï∞ÊçÆÂç∑Ë∑ØÂæÑ
      RUSTFS_VOLUMES: /data/rustfs0
      # API ÂíåÊéßÂà∂Âè∞ÁõëÂê¨Âú∞ÂùÄ
      RUSTFS_ADDRESS: 0.0.0.0:9000
      RUSTFS_CONSOLE_ADDRESS: 0.0.0.0:9001
      RUSTFS_CONSOLE_ENABLE: "true"
      # CORS ËÆæÁΩÆ
      RUSTFS_CORS_ALLOWED_ORIGINS: "*"
      RUSTFS_CONSOLE_CORS_ALLOWED_ORIGINS: "*"
      # ËÆøÈóÆÂØÜÈí•
      RUSTFS_ACCESS_KEY: ${RUSTFS_ROOT_USER:-rustfsadmin}
      RUSTFS_SECRET_KEY: ${RUSTFS_ROOT_PASSWORD:-rustfsadmin}
      # Á¶ÅÁî® KMS Âä†ÂØÜÊúçÂä°ÔºàÈÅøÂÖç KMS Êú™ÂàùÂßãÂåñÈîôËØØÔºâ
      MINIO_KMS_KES_ENDPOINT: ""
      MINIO_KMS_AUTO_ENCRYPTION: "off"
      # Êó•ÂøóÁ∫ßÂà´
      RUSTFS_OBS_LOGGER_LEVEL: info
      # Êó∂Âå∫ÈÖçÁΩÆ
      TZ: Asia/Shanghai
    volumes:
      - ${RUSTFS_DATA_DIR:-./rustfs/data}:/data
      - ${RUSTFS_LOG_DIR:-./rustfs/logs}:/app/logs
    # Á´ØÂè£Êò†Â∞ÑÔºöÂè™Êö¥Èú≤ RustFS Console ÁÆ°ÁêÜÁïåÈù¢Âà∞‰∏ªÊú∫
    # API Á´ØÂè£Ôºà9000Ôºâ‰∏çÊö¥Èú≤ÔºåÊâÄÊúâÊñá‰ª∂ËÆøÈóÆÈÄöËøá Nginx ‰ª£ÁêÜ
    ports:
      - "${RUSTFS_CONSOLE_PORT:-7901}:9001"  # ÁÆ°ÁêÜÊéßÂà∂Âè∞Á´ØÂè£ - Áõ¥Êé•ËÆøÈóÆÔºàhttp://ÊúçÂä°Âô®IP:7901Ôºâ
    networks:
      - secsnow-network
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:9000/health && curl -f http://localhost:9001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # RustFS ÂàùÂßãÂåñÔºàËá™Âä®ÂàõÂª∫ bucketÔºâ
  rustfs-init:
    image: ${MINIO_MC_IMAGE:-minio/mc:latest}  # ‰ΩøÁî® minio clientÔºåÂõ†‰∏∫ RustFS ÂÖºÂÆπ S3 API
    container_name: ${CONTAINER_PREFIX:-secsnow}-rustfs-init
    depends_on:
      rustfs:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      echo 'Á≠âÂæÖ RustFS ÂêØÂä®...';
      sleep 5;
      echo 'ÈÖçÁΩÆ RustFS Âà´Âêç...';
      mc alias set secsnow http://rustfs:9000 ${RUSTFS_ROOT_USER:-rustfsadmin} ${RUSTFS_ROOT_PASSWORD:-rustfsadmin};
      echo 'ÂàõÂª∫ bucket: ${RUSTFS_BUCKET_NAME:-secsnow}';
      mc mb secsnow/${RUSTFS_BUCKET_NAME:-secsnow} --ignore-existing;
      echo 'ËÆæÁΩÆ bucket ‰∏∫ÂÖ¨ÂºÄËÆøÈóÆ...';
      mc anonymous set public secsnow/${RUSTFS_BUCKET_NAME:-secsnow};
      echo 'RustFS ÂàùÂßãÂåñÂÆåÊàêÔºÅ';
      "
    networks:
      - secsnow-network

  # Django Web Â∫îÁî®ÔºàÂâçÁ´ØÔºâ
  web:
    image: ${SECSNOW_IMAGE:-secsnow:secure}
    container_name: ${CONTAINER_PREFIX:-secsnow}-web
    restart: always
    environment:
      # Django ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_SECRET_KEY: ${SNOW_SECRET_KEY:-django-insecure-)+vh#@l4crslu5fza1e8da!2(0s10mw5%_1=*uko7cu9ju*yv-}
      SNOW_DEBUG: ${SNOW_DEBUG:-False}
      SNOW_ALLOWED_HOSTS: ${SNOW_ALLOWED_HOSTS:-*}
      # Êï∞ÊçÆÂ∫ìÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ- ÈÄöËøá PgBouncer ËøûÊé•
      SNOW_POSTGRES_HOST: pgbouncer
      SNOW_POSTGRES_PORT: 5432
      SNOW_POSTGRES_NAME: ${POSTGRES_DB:-secsnow}
      SNOW_POSTGRES_USER: ${POSTGRES_USER:-secsnow}
      SNOW_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secsnow123456}
      # Redis ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_REDIS_HOST: redis
      SNOW_REDIS_PORT: 6379
      SNOW_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
      # ÂØπË±°Â≠òÂÇ®ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºåÊîØÊåÅ RustFSÔºâ
      SNOW_USE_OBJECT_STORAGE: ${SNOW_USE_OBJECT_STORAGE:-False}
      SNOW_STORAGE_ACCESS_KEY: ${SNOW_STORAGE_ACCESS_KEY:-rustfsadmin}
      SNOW_STORAGE_SECRET_KEY: ${SNOW_STORAGE_SECRET_KEY:-rustfsadmin}
      SNOW_STORAGE_BUCKET_NAME: ${SNOW_STORAGE_BUCKET_NAME:-secsnow}
      SNOW_STORAGE_ENDPOINT_URL: ${SNOW_STORAGE_ENDPOINT_URL:-http://rustfs:9000}
      SNOW_STORAGE_REGION: ${SNOW_STORAGE_REGION:-us-east-1}
      SNOW_STORAGE_LOCATION: ${SNOW_STORAGE_LOCATION:-}
      SNOW_STORAGE_USE_SSL: ${SNOW_STORAGE_USE_SSL:-False}
      SNOW_STORAGE_VERIFY_SSL: ${SNOW_STORAGE_VERIFY_SSL:-False}
      SNOW_STORAGE_PUBLIC_URL: ${SNOW_STORAGE_PUBLIC_URL:-}
      SECSNOW_VERSION: ${SECSNOW_VERSION:-v1.0.0}
      # Êó∂Âå∫ÈÖçÁΩÆ
      TZ: Asia/Shanghai
        
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${WEB_MEDIA_DIR:-./web/media}:/opt/cloud/secsnow/media
      - ${WEB_LOG_DIR:-./web/log}:/opt/cloud/secsnow/log
      - ${WEB_STATIC_DIR:-./web/static}:/opt/cloud/secsnow/static
      - ${WEB_WHOOSH_DIR:-./web/whoosh_index}:/opt/cloud/secsnow/whoosh_index
      # ÊåÇËΩΩÂÆø‰∏ªÊú∫‰ø°ÊÅØÔºàÁî®‰∫éÁîüÊàêÁ®≥ÂÆöÁöÑÊú∫Âô®Á†ÅÔºâ
      - /etc/machine-id:/host/etc/machine-id:ro
      - /sys/class/net:/host/sys/class/net:ro
    # ‰∏çÊö¥Èú≤Á´ØÂè£Âà∞‰∏ªÊú∫ÔºåÂè™ÈÄöËøá nginx ‰ª£ÁêÜËÆøÈóÆ
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - secsnow-network
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Celery WorkerÔºàÂÖ±‰∫´ web ÈïúÂÉèÔºâ
  celery-worker:
    image: ${SECSNOW_IMAGE:-secsnow:secure}
    container_name: ${CONTAINER_PREFIX:-secsnow}-celery-worker
    restart: always
    command: celery -A secsnow worker -l info --concurrency=${CELERY_WORKER_CONCURRENCY:-4}
    environment:
      # Django ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_SECRET_KEY: ${SNOW_SECRET_KEY:-change-this-to-random-string}
      SNOW_DEBUG: ${SNOW_DEBUG:-False}
      # Êï∞ÊçÆÂ∫ìÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ- ÈÄöËøá PgBouncer ËøûÊé•
      SNOW_POSTGRES_HOST: pgbouncer
      SNOW_POSTGRES_PORT: 5432
      SNOW_POSTGRES_NAME: ${POSTGRES_DB:-secsnow}
      SNOW_POSTGRES_USER: ${POSTGRES_USER:-secsnow}
      SNOW_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secsnow123456}
      # Redis ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_REDIS_HOST: redis
      SNOW_REDIS_PORT: 6379
      SNOW_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
      # ÂØπË±°Â≠òÂÇ®ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºåÊîØÊåÅ RustFSÔºâ
      SNOW_USE_OBJECT_STORAGE: ${SNOW_USE_OBJECT_STORAGE:-False}
      SNOW_STORAGE_ACCESS_KEY: ${SNOW_STORAGE_ACCESS_KEY:-rustfsadmin}
      SNOW_STORAGE_SECRET_KEY: ${SNOW_STORAGE_SECRET_KEY:-rustfsadmin}
      SNOW_STORAGE_BUCKET_NAME: ${SNOW_STORAGE_BUCKET_NAME:-secsnow}
      SNOW_STORAGE_ENDPOINT_URL: ${SNOW_STORAGE_ENDPOINT_URL:-http://rustfs:9000}
      SNOW_STORAGE_REGION: ${SNOW_STORAGE_REGION:-us-east-1}
      SNOW_STORAGE_LOCATION: ${SNOW_STORAGE_LOCATION:-}
      SNOW_STORAGE_USE_SSL: ${SNOW_STORAGE_USE_SSL:-False}
      SNOW_STORAGE_VERIFY_SSL: ${SNOW_STORAGE_VERIFY_SSL:-False}
      SNOW_STORAGE_PUBLIC_URL: ${SNOW_STORAGE_PUBLIC_URL:-}
      # Êó∂Âå∫ÈÖçÁΩÆ
      TZ: Asia/Shanghai
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${WEB_MEDIA_DIR:-./web/media}:/opt/cloud/secsnow/media
      - ${WEB_LOG_DIR:-./web/log}:/opt/cloud/secsnow/log
      # ÊåÇËΩΩÂÆø‰∏ªÊú∫‰ø°ÊÅØÔºàÁî®‰∫éÁîüÊàêÁ®≥ÂÆöÁöÑÊú∫Âô®Á†ÅÔºâ
      - /etc/machine-id:/host/etc/machine-id:ro
      - /sys/class/net:/host/sys/class/net:ro
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
      web:
        condition: service_started
    networks:
      - secsnow-network
    healthcheck:
      test: ["CMD", "celery", "-A", "secsnow", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Celery BeatÔºàÂÖ±‰∫´ web ÈïúÂÉèÔºâ
  celery-beat:
    image: ${SECSNOW_IMAGE:-secsnow:secure}
    container_name: ${CONTAINER_PREFIX:-secsnow}-celery-beat
    restart: always
    command: celery -A secsnow beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    environment:
      # Django ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_SECRET_KEY: ${SNOW_SECRET_KEY:-change-this-to-random-string}
      SNOW_DEBUG: ${SNOW_DEBUG:-False}
      # Êï∞ÊçÆÂ∫ìÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ- ÈÄöËøá PgBouncer ËøûÊé•
      SNOW_POSTGRES_HOST: pgbouncer
      SNOW_POSTGRES_PORT: 5432
      SNOW_POSTGRES_NAME: ${POSTGRES_DB:-secsnow}
      SNOW_POSTGRES_USER: ${POSTGRES_USER:-secsnow}
      SNOW_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secsnow123456}
      # Redis ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_REDIS_HOST: redis
      SNOW_REDIS_PORT: 6379
      SNOW_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
      # ÂØπË±°Â≠òÂÇ®ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºåÊîØÊåÅ RustFSÔºâ
      SNOW_USE_OBJECT_STORAGE: ${SNOW_USE_OBJECT_STORAGE:-False}
      SNOW_STORAGE_ACCESS_KEY: ${SNOW_STORAGE_ACCESS_KEY:-rustfsadmin}
      SNOW_STORAGE_SECRET_KEY: ${SNOW_STORAGE_SECRET_KEY:-rustfsadmin}
      SNOW_STORAGE_BUCKET_NAME: ${SNOW_STORAGE_BUCKET_NAME:-secsnow}
      SNOW_STORAGE_ENDPOINT_URL: ${SNOW_STORAGE_ENDPOINT_URL:-http://rustfs:9000}
      SNOW_STORAGE_REGION: ${SNOW_STORAGE_REGION:-us-east-1}
      SNOW_STORAGE_LOCATION: ${SNOW_STORAGE_LOCATION:-}
      SNOW_STORAGE_USE_SSL: ${SNOW_STORAGE_USE_SSL:-False}
      SNOW_STORAGE_VERIFY_SSL: ${SNOW_STORAGE_VERIFY_SSL:-False}
      SNOW_STORAGE_PUBLIC_URL: ${SNOW_STORAGE_PUBLIC_URL:-}
      # Êó∂Âå∫ÈÖçÁΩÆ
      TZ: Asia/Shanghai
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${WEB_LOG_DIR:-./web/log}:/opt/cloud/secsnow/log
      # ÊåÇËΩΩÂÆø‰∏ªÊú∫‰ø°ÊÅØÔºàÁî®‰∫éÁîüÊàêÁ®≥ÂÆöÁöÑÊú∫Âô®Á†ÅÔºâ
      - /etc/machine-id:/host/etc/machine-id:ro
      - /sys/class/net:/host/sys/class/net:ro
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
      web:
        condition: service_started
    networks:
      - secsnow-network

  # Flower ÁõëÊéßÔºàÂèØÈÄâÊúçÂä° - ‰ΩøÁî® --profile Flower ÂêØÂä®Ôºâ
  flower:
    profiles:
      - Flower  # ÈúÄË¶Å‰ΩøÁî® --profile Flower ÂèÇÊï∞Êâç‰ºöÂêØÂä®Ê≠§ÊúçÂä°
    image: ${SECSNOW_IMAGE:-secsnow:secure}
    container_name: ${CONTAINER_PREFIX:-secsnow}-flower
    restart: always
    # Ê∑ªÂä†Âü∫Êú¨ËÆ§ËØÅ‰øùÊä§ÔºàÁî®Êà∑Âêç:ÂØÜÁ†ÅÊ†ºÂºèÔºâ
    command: >
      celery -A secsnow flower 
      --port=5555 
      --basic_auth=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-flower123456}
    environment:
      # Redis ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_REDIS_HOST: redis
      SNOW_REDIS_PORT: 6379
      SNOW_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
      # Êó∂Âå∫ÈÖçÁΩÆ
      TZ: Asia/Shanghai
    # Áõ¥Êé•Êö¥Èú≤ 5555 Á´ØÂè£Âà∞‰∏ªÊú∫
    ports:
      - "${FLOWER_PORT:-5555}:5555"
    depends_on:
      - redis
      - celery-worker
    networks:
      - secsnow-network

  # Nginx ÂèçÂêë‰ª£ÁêÜ
  nginx:
    image: ${NGINX_IMAGE:-nginx:alpine}
    container_name: ${CONTAINER_PREFIX:-secsnow}-nginx
    restart: always
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${NGINX_CONF_DIR:-./nginx/conf.d}:/etc/nginx/conf.d:ro
      - ${NGINX_SSL_DIR:-./nginx/ssl}:/etc/nginx/ssl:ro
      - ${WEB_MEDIA_DIR:-./web/media}:/usr/share/nginx/secsnow/media
      - ${WEB_STATIC_DIR:-./web/static}:/usr/share/nginx/secsnow/static
      - ${NGINX_LOG_DIR:-./web/log/nginx}:/var/log/nginx
    depends_on:
      - web
    networks:
      - secsnow-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  secsnow-network:
    name: ${NETWORK_NAME:-secsnow-network}
    driver: bridge

volumes:
  postgres-data:
  redis-data:

