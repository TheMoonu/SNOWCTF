[databases]
* = host=postgres port=5432

[pgbouncer]
listen_addr = 0.0.0.0
listen_port = 5432
auth_type = scram-sha-256
# 使用 auth_query 从 PostgreSQL 动态获取用户认证（不需要 userlist.txt）
auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1
admin_users = postgres
stats_users = postgres

# 连接池配置（4核8G优化 - 支持156并发：150 gevent + 6 prefork）
pool_mode = transaction
max_client_conn = 2000          # 最大客户端连接（1000 → 2000）
default_pool_size = 100         # 默认连接池（25 → 100）支持156并发
min_pool_size = 20              # 最小连接池（5 → 20）
reserve_pool_size = 20          # 预留连接池（5 → 20）
max_db_connections = 150        # 最大数据库连接（50 → 150）

# 超时配置（优化查询和连接超时）
server_idle_timeout = 120       # 空闲超时2分钟（60 → 120）
server_lifetime = 3600          # 连接生命周期1小时
server_connect_timeout = 15     # 连接超时15秒
query_timeout = 30              # 查询超时30秒（0 → 30，防止慢查询卡死）
client_idle_timeout = 0         # 客户端空闲超时（0=无限制）

# 日志配置
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

# 其他配置
ignore_startup_parameters = extra_float_digits

